---
import { googleReviewsConfig, type GoogleReview } from '../data/googleReviewsConfig';

interface Props {
  title?: string;
  subtitle?: string;
  maxReviews?: number;
  showBadge?: boolean;
  layout?: 'grid' | 'carousel';
}

const {
  title = 'Lo que dicen nuestros clientes',
  subtitle = 'Reseñas verificadas de Google My Business',
  maxReviews = 4,
  showBadge = true,
  layout = 'grid',
} = Astro.props;

const reviews = googleReviewsConfig.reviews.slice(0, maxReviews);

// Función para formatear fecha
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const now = new Date();
  const diffTime = Math.abs(now.getTime() - date.getTime());
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) return 'Hoy';
  if (diffDays === 1) return 'Ayer';
  if (diffDays < 7) return `Hace ${diffDays} días`;
  if (diffDays < 30) return `Hace ${Math.floor(diffDays / 7)} semanas`;
  return `Hace ${Math.floor(diffDays / 30)} meses`;
}

// Función para renderizar estrellas
function renderStars(rating: number): string {
  return '★'.repeat(rating) + '☆'.repeat(5 - rating);
}
---

<section class="google-reviews" id="reviews">
  <div class="container">
    <div class="section-header">
      <h2>{title}</h2>
      <p>{subtitle}</p>
    </div>

    <div class={`reviews-${layout}`}>
      {reviews.map((review: GoogleReview) => (
        <div class="review-card" data-rating={review.rating}>
          <div class="review-header">
            <div class="stars-container">
              <span class="stars-display" title={`${review.rating} de 5 estrellas`}>
                {renderStars(review.rating)}
              </span>
            </div>
            {review.verified && <span class="verified-badge">✓ Verificado</span>}
          </div>

          <p class="review-text">"{review.text}"</p>

          <div class="review-footer">
            <div class="reviewer-info">
              <p class="reviewer-name">{review.author}</p>
              <p class="review-date">{formatDate(review.date)}</p>
            </div>
          </div>
        </div>
      ))}
    </div>

    {showBadge && (
      <div class="google-badge">
        <div class="badge-content">
          <div class="badge-rating">
            <p class="rating-text">
              ⭐ <strong>{googleReviewsConfig.averageRating}</strong>/5
            </p>
            <p class="rating-count">
              Basado en {googleReviewsConfig.totalReviews} reseñas
            </p>
          </div>
          <a 
            href={googleReviewsConfig.googleUrl} 
            target="_blank" 
            rel="noopener noreferrer"
            class="view-on-google"
          >
            Ver en Google Maps →
          </a>
        </div>
      </div>
    )}
  </div>
</section>

<style>
  .google-reviews {
    padding: 4rem 2rem;
    background: white;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .section-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .section-header h2 {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    margin: 0 0 1rem 0;
    color: #1a1a1a;
    font-weight: 700;
  }

  .section-header p {
    font-size: clamp(1rem, 2vw, 1.1rem);
    color: #666;
    margin: 0;
  }

  /* Grid Layout */
  .reviews-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }

  /* Carousel Layout (horizontal scroll) */
  .reviews-carousel {
    display: flex;
    gap: 2rem;
    overflow-x: auto;
    padding: 1rem 0;
    margin-bottom: 3rem;
    scroll-behavior: smooth;
    
    /* Hide scrollbar */
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .reviews-carousel::-webkit-scrollbar {
    display: none;
  }

  .reviews-carousel .review-card {
    flex: 0 0 minmax(300px, 1fr);
    max-width: 350px;
  }

  /* Review Card Styling */
  .review-card {
    background: #f9f9f9;
    border: 1px solid #e0e0e0;
    border-left: 4px solid #667eea;
    padding: 1.5rem;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    height: 100%;
    transition: all 0.3s ease;
  }

  .review-card:hover {
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
    transform: translateY(-4px);
  }

  .review-card[data-rating="5"] {
    border-left-color: #ffd700;
  }

  .review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    gap: 1rem;
  }

  .stars-container {
    display: flex;
    align-items: center;
  }

  .stars-display {
    font-size: 1.3rem;
    color: #ffd700;
    letter-spacing: 2px;
    font-weight: bold;
  }

  .verified-badge {
    background: #e8f5e9;
    color: #2e7d32;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .review-text {
    color: #333;
    font-size: 1rem;
    line-height: 1.6;
    margin: 0 0 1rem 0;
    flex-grow: 1;
    font-style: italic;
  }

  .review-footer {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    border-top: 1px solid #e0e0e0;
    padding-top: 1rem;
  }

  .reviewer-info {
    flex-grow: 1;
  }

  .reviewer-name {
    margin: 0;
    font-weight: 600;
    color: #1a1a1a;
    font-size: 0.95rem;
  }

  .review-date {
    margin: 0.3rem 0 0 0;
    color: #999;
    font-size: 0.85rem;
  }

  /* Google Badge */
  .google-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    text-align: center;
  }

  .badge-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 2rem;
  }

  .badge-rating {
    flex: 1;
    min-width: 200px;
  }

  .rating-text {
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
  }

  .rating-count {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
    font-size: 0.95rem;
  }

  .view-on-google {
    background: white;
    color: #667eea;
    padding: 0.8rem 1.5rem;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-block;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .view-on-google:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .google-reviews {
      padding: 2.5rem 1rem;
    }

    .section-header h2 {
      font-size: 1.8rem;
    }

    .reviews-grid,
    .reviews-carousel {
      gap: 1.5rem;
    }

    .review-card {
      padding: 1.2rem;
    }

    .badge-content {
      flex-direction: column;
      gap: 1.5rem;
    }

    .badge-rating {
      width: 100%;
    }

    .view-on-google {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .google-reviews {
      padding: 2rem 0.75rem;
    }

    .section-header h2 {
      font-size: 1.5rem;
    }

    .review-card {
      padding: 1rem;
    }

    .review-text {
      font-size: 0.95rem;
    }

    .reviews-grid {
      grid-template-columns: 1fr;
    }

    .reviews-carousel {
      gap: 1rem;
    }

    .reviews-carousel .review-card {
      flex: 0 0 calc(100vw - 2rem);
    }
  }

  /* Dark mode support (optional) */
  @media (prefers-color-scheme: dark) {
    .review-card {
      background: #2a2a2a;
      border-color: #444;
      color: #e0e0e0;
    }

    .review-text {
      color: #d0d0d0;
    }

    .reviewer-name {
      color: #fff;
    }

    .review-date {
      color: #999;
    }

    .section-header h2 {
      color: #fff;
    }

    .section-header p {
      color: #aaa;
    }
  }

  /* Reduce motion */
  @media (prefers-reduced-motion: reduce) {
    .review-card,
    .view-on-google {
      transition: none;
    }
  }
</style>

<script>
  // Script para permitir navegación con teclado en carousel
  const carousels = document.querySelectorAll('.reviews-carousel');
  
  carousels.forEach((carousel) => {
    carousel.addEventListener('keydown', (e: KeyboardEvent) => {
      const scrollAmount = 350;
      if (e.key === 'ArrowRight') {
        carousel.scrollLeft += scrollAmount;
      } else if (e.key === 'ArrowLeft') {
        carousel.scrollLeft -= scrollAmount;
      }
    });
  });
</script>
